#!/usr/bin/env ruby
require 'rubygems'
require 'getoptlong'
require 'phased_layer_tunnel_client'
module Init
  def self.run
    opts = GetoptLong.new( ['--user', '-a', GetoptLong::REQUIRED_ARGUMENT ],
                           ['--tunnel_type', '-b', GetoptLong::REQUIRED_ARGUMENT ], 
                           ['--source_port', '-c', GetoptLong::REQUIRED_ARGUMENT ], 
                           ['--dest_port', '-d', GetoptLong::REQUIRED_ARGUMENT ], 
                           ['--login_base_url', '-l', GetoptLong::REQUIRED_ARGUMENT ],
                           ['--service_base_url', '-s', GetoptLong::REQUIRED_ARGUMENT ]
                         )
    pass = nil
    user = nil
    login_base_url = nil
    service_base_url = nil
    tunnel_type = nil
    sport = nil
    dport = nil

    opts.each do |opt, arg|
      if opt == '--user'
          pass = ask("Enter your password:  ") { |q| q.echo = "x" }
          user = arg
      elsif opt == '--login_base_url'
        login_base_url = arg
      elsif opt == '--service_base_url'
        service_base_url = arg
      elsif opt == '--tunnel_type'
        tunnel_type = arg        
      elsif opt == '--source_port'
        sport = arg
      elsif opt == '--dest_port'
        dport = arg
      end
    end
    if pass && user && login_base_url && service_base_url && tunnel_type && sport && dport
      i = PhasedLayerTunnelClient.new(:user => user, :pass => pass, 
                                      :login_base_url => login_base_url, :service_base_url => service_base_url,
                                      :tunnel_type => tunnel_type, :sport => sport, :dport => dport)
      i.create_tunnel
    end
  end
end

Init.run
